<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>SplitEasy â€” Group Expense Manager</title>
<meta name="theme-color" content="#1B998B">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="SplitEasy">
<meta name="description" content="Split group expenses easily. Track who owes what and simplify debts.">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --teal:#1B998B;--teal-light:#E6F5F3;--teal-dark:#14776C;--teal-50:rgba(27,153,139,0.08);
  --orange:#FF6B35;--red:#E8453C;--red-light:#FDECEB;
  --bg:#F5F6F8;--white:#fff;--card:#fff;
  --text:#1A1D26;--text-2:#6B7280;--text-3:#9CA3AF;
  --border:#E5E7EB;--border-l:#F0F1F3;
  --sh-sm:0 1px 2px rgba(0,0,0,0.05);--sh-lg:0 8px 30px rgba(0,0,0,0.12);
  --r:16px;--r-sm:10px;
  --font:'Plus Jakarta Sans',system-ui,sans-serif;
  --sab:env(safe-area-inset-bottom,0px);
}
html{-webkit-tap-highlight-color:transparent}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}

/* Header */
.top-hdr{background:var(--teal);color:#fff;padding:env(safe-area-inset-top,12px) 20px 20px;position:sticky;top:0;z-index:40}
.top-row{display:flex;align-items:center;justify-content:space-between;padding-top:8px}
.top-hdr h1{font-size:1.35rem;font-weight:800;letter-spacing:-0.02em}
.top-acts{display:flex;gap:6px}
.i-btn{width:38px;height:38px;border-radius:50%;border:none;background:rgba(255,255,255,0.18);color:#fff;font-size:1.1rem;display:flex;align-items:center;justify-content:center;cursor:pointer}
.i-btn:active{background:rgba(255,255,255,0.3)}

/* Balance Hero */
.b-hero{background:var(--teal);padding:0 20px 28px;margin-bottom:-20px;position:relative;z-index:1}
.b-hero::after{content:'';position:absolute;bottom:0;left:0;right:0;height:24px;background:var(--bg);border-radius:20px 20px 0 0}
.b-cards{display:flex;gap:10px;position:relative;z-index:2}
.b-card{flex:1;background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.12)}
.b-card-l{font-size:0.7rem;text-transform:uppercase;letter-spacing:0.06em;color:rgba(255,255,255,0.75);margin-bottom:4px;font-weight:600}
.b-card-v{font-size:1.3rem;font-weight:800;color:#fff}
.b-card-v.pos{color:#A7F3D0}.b-card-v.neg{color:#FCA5A5}

.main{padding:28px 16px 120px;max-width:560px;margin:0 auto}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding:0 4px}
.sec-t{font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-2)}
.sec-a{font-size:0.8rem;font-weight:600;color:var(--teal);border:none;background:none;cursor:pointer}
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--sh-sm);border:1px solid var(--border-l);overflow:hidden;margin-bottom:14px}
.card-p{padding:18px}

/* Activity Items */
.a-item{display:flex;align-items:flex-start;gap:14px;padding:16px 18px;border-bottom:1px solid var(--border-l);cursor:pointer;position:relative;transition:background .12s}
.a-item:last-child{border-bottom:none}.a-item:active{background:var(--teal-50)}
.a-ico{width:44px;height:44px;border-radius:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:1.25rem}
.c-food{background:#FEF3C7}.c-rent{background:#DBEAFE}.c-trans{background:#E0E7FF}.c-groc{background:#D1FAE5}.c-ent{background:#FCE7F3}.c-util{background:#FEE2E2}.c-med{background:#EDE9FE}.c-oth{background:#F3F4F6}
.a-body{flex:1;min-width:0}
.a-desc{font-weight:600;font-size:0.92rem;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.a-meta{font-size:0.78rem;color:var(--text-2);margin-top:3px}
.a-right{text-align:right;flex-shrink:0;margin-left:8px}
.a-amt{font-weight:700;font-size:0.95rem}
.a-amt.paid{color:var(--teal)}.a-amt.owe{color:var(--red)}
.a-sub{font-size:0.72rem;color:var(--text-3);margin-top:2px}

/* Person Items */
.p-item{display:flex;align-items:center;gap:14px;padding:14px 18px;border-bottom:1px solid var(--border-l)}
.p-item:last-child{border-bottom:none}
.av{width:42px;height:42px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;color:#fff}
.av-s{width:34px;height:34px;font-size:0.78rem}
.av-xs{width:28px;height:28px;font-size:0.68rem}
.av-xxs{width:24px;height:24px;font-size:0.6rem}
.p-info{flex:1;min-width:0}.p-name{font-weight:600;font-size:0.92rem}.p-det{font-size:0.78rem;color:var(--text-2);margin-top:1px}
.p-amt{font-weight:700;font-size:0.92rem;text-align:right;flex-shrink:0}
.am-pos{color:var(--teal)}.am-neg{color:var(--red)}.am-z{color:var(--text-3)}

/* Settle Cards */
.s-card{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card);border-radius:var(--r-sm);margin-bottom:10px;box-shadow:var(--sh-sm);border:1px solid var(--border-l)}
.s-flow{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.s-arr{color:var(--teal);font-weight:700;flex-shrink:0}
.s-amt{font-weight:800;font-size:1rem;color:var(--teal);flex-shrink:0}

/* FAB */
.fab{position:fixed;bottom:calc(76px + var(--sab));left:50%;transform:translateX(-50%);z-index:50;width:60px;height:60px;border-radius:50%;border:none;background:var(--orange);color:#fff;font-size:1.8rem;box-shadow:0 4px 20px rgba(255,107,53,0.4);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;line-height:1}
.fab:active{transform:translateX(-50%) scale(0.92)}

/* Bottom Nav */
.b-nav{position:fixed;bottom:0;left:0;right:0;z-index:45;background:var(--white);border-top:1px solid var(--border);padding-bottom:var(--sab);display:flex}
.n-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 0 8px;border:none;background:none;color:var(--text-3);font-size:0.65rem;font-weight:600;cursor:pointer;font-family:var(--font)}
.n-item.act{color:var(--teal)}.n-ico{font-size:1.3rem;line-height:1}
.n-item:nth-child(3){width:72px}

/* Sections */
.sec{display:none;animation:fs .25s ease}.sec.act{display:block}
@keyframes fs{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Form */
.fg{margin-bottom:16px}
.fl{display:block;font-size:0.78rem;font-weight:600;color:var(--text-2);margin-bottom:7px}
.fi{width:100%;padding:13px 16px;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text);font-family:var(--font);font-size:0.92rem;outline:none;transition:all .2s}
.fi:focus{border-color:var(--teal);background:var(--white);box-shadow:0 0 0 3px var(--teal-50)}
.fi::placeholder{color:var(--text-3)}
select.fi{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px}
.fr{display:flex;gap:10px}.fr>*{flex:1}
.amt-w{position:relative}.amt-w .cpx{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-weight:700;font-size:1rem;color:var(--text-2)}
.amt-w .fi{padding-left:36px;font-weight:700;font-size:1.1rem}

/* Chips */
.cg{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:8px 14px 8px 8px;border-radius:50px;border:1.5px solid var(--border);background:var(--white);font-size:0.82rem;font-weight:500;cursor:pointer;transition:all .15s;font-family:var(--font);color:var(--text)}
.chip.sel{border-color:var(--teal);background:var(--teal-light);color:var(--teal-dark)}

/* Buttons */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--r-sm);font-family:var(--font);font-size:0.92rem;font-weight:700;cursor:pointer;transition:all .15s;width:100%}
.btn-p{background:var(--teal);color:#fff;box-shadow:0 2px 12px rgba(27,153,139,0.25)}.btn-p:active{transform:scale(0.98)}
.btn-s{background:var(--bg);color:var(--text);border:1.5px solid var(--border)}
.btn-d{background:var(--red-light);color:var(--red)}
.btn-sm{padding:10px 18px;font-size:0.82rem;width:auto}

/* Empty */
.empty{text-align:center;padding:48px 24px}
.empty-i{font-size:3.5rem;margin-bottom:14px;opacity:0.9}
.empty-t{font-weight:700;font-size:1.05rem;margin-bottom:6px}
.empty-d{font-size:0.85rem;color:var(--text-2);line-height:1.5;max-width:260px;margin:0 auto}

/* Modal */
.mo{display:none;position:fixed;inset:0;z-index:60;background:rgba(0,0,0,0.4);backdrop-filter:blur(3px)}
.mo.show{display:flex;align-items:flex-end;justify-content:center}
.ms{background:var(--white);width:100%;max-width:560px;border-radius:20px 20px 0 0;max-height:92dvh;overflow-y:auto;animation:su .3s cubic-bezier(.22,1,.36,1);padding-bottom:var(--sab);scrollbar-width:none}
.ms::-webkit-scrollbar{display:none}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.m-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:10px auto 0}
.m-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px;position:sticky;top:0;background:var(--white);z-index:1}
.m-title{font-weight:800;font-size:1.15rem}
.m-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--bg);color:var(--text-2);font-size:1.2rem;display:flex;align-items:center;justify-content:center;cursor:pointer}
.m-body{padding:4px 20px 24px}

/* Toggle */
.tg-row{display:flex;align-items:center;justify-content:space-between;padding:4px 0}
.tg-l{font-size:0.9rem;font-weight:600}.tg-s{font-size:0.75rem;color:var(--text-2);margin-top:1px}
.tg{position:relative;width:48px;height:28px;border-radius:14px;background:var(--border);border:none;cursor:pointer;transition:background .25s;flex-shrink:0}
.tg.on{background:var(--teal)}
.tg::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;box-shadow:var(--sh-sm);transition:transform .25s}
.tg.on::after{transform:translateX(20px)}

/* Toast */
.toast{position:fixed;bottom:calc(90px + var(--sab));left:50%;transform:translateX(-50%) translateY(16px);background:var(--text);color:#fff;padding:12px 24px;border-radius:50px;font-size:0.85rem;font-weight:600;box-shadow:var(--sh-lg);opacity:0;transition:all .3s cubic-bezier(.22,1,.36,1);z-index:100;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Member chips */
.mc{display:inline-flex;align-items:center;gap:6px;padding:6px 12px 6px 6px;background:var(--bg);border-radius:50px;font-size:0.82rem;font-weight:500;animation:pi .2s ease}
@keyframes pi{from{opacity:0;scale:.92}to{opacity:1;scale:1}}
.mc-x{background:none;border:none;color:var(--text-3);cursor:pointer;font-size:0.9rem;padding:0 2px}
.mc-x:hover{color:var(--red)}

/* Settings */
.st-row{display:flex;align-items:center;gap:14px;padding:16px 18px;border-bottom:1px solid var(--border-l);cursor:pointer;transition:background .12s}
.st-row:active{background:var(--bg)}.st-row:last-child{border-bottom:none}
.st-ico{font-size:1.3rem;width:36px;text-align:center;flex-shrink:0}
.st-txt{flex:1}.st-m{font-weight:600;font-size:0.9rem}.st-s{font-size:0.75rem;color:var(--text-2);margin-top:1px}
.st-chv{color:var(--text-3);font-size:0.8rem}

@media(max-width:380px){.b-card-v{font-size:1.1rem}.top-hdr h1{font-size:1.2rem}}
</style>
</head>
<body>

<header class="top-hdr">
  <div class="top-row">
    <h1>SplitEasy</h1>
    <div class="top-acts">
      <button class="i-btn" onclick="openSearch()">ğŸ”</button>
      <button class="i-btn" onclick="switchNav('settings')">âš™ï¸</button>
    </div>
  </div>
</header>

<div class="b-hero" id="bHero">
  <div class="b-cards" id="bCards"></div>
</div>

<main class="main">
  <!-- Activity -->
  <section id="s-activity" class="sec act">
    <div class="sec-hdr">
      <span class="sec-t">Recent Activity</span>
      <button class="sec-a" id="filterBtn" onclick="cycleFilter()">All</button>
    </div>
    <div id="actList" class="card"></div>
  </section>

  <!-- Friends -->
  <section id="s-friends" class="sec">
    <div class="sec-hdr"><span class="sec-t">Friends & Balances</span></div>
    <div id="fList" class="card"></div>
  </section>

  <!-- Settle -->
  <section id="s-settle" class="sec">
    <div class="card card-p" style="margin-bottom:14px">
      <div class="tg-row">
        <div><div class="tg-l">Simplify debts</div><div class="tg-s">Minimize total number of payments</div></div>
        <button class="tg on" id="simpTg" onclick="toggleSimplify()"></button>
      </div>
    </div>
    <div class="sec-hdr"><span class="sec-t">Suggested Settlements</span></div>
    <div id="setList"></div>
  </section>

  <!-- Settings -->
  <section id="s-settings" class="sec">
    <div class="sec-hdr"><span class="sec-t">Group Members</span></div>
    <div class="card" style="margin-bottom:16px">
      <div style="padding:16px 18px">
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px" id="memList"></div>
        <div style="display:flex;gap:8px">
          <input type="text" class="fi" id="newMem" placeholder="Add a friend..." style="margin:0;flex:1" onkeydown="if(event.key==='Enter')addMember()">
          <button class="btn btn-p btn-sm" onclick="addMember()" style="width:auto;padding:10px 18px">Add</button>
        </div>
      </div>
    </div>
    <div class="sec-hdr"><span class="sec-t">Settings</span></div>
    <div class="card">
      <div class="st-row" onclick="openCurrency()">
        <span class="st-ico">ğŸ’±</span>
        <div class="st-txt"><div class="st-m">Currency</div><div class="st-s" id="curDisp">â‚¹ (INR)</div></div>
        <span class="st-chv">â€º</span>
      </div>
      <div class="st-row" onclick="exportData()">
        <span class="st-ico">ğŸ“¤</span>
        <div class="st-txt"><div class="st-m">Export Data</div><div class="st-s">Download JSON backup</div></div>
        <span class="st-chv">â€º</span>
      </div>
      <div class="st-row" onclick="document.getElementById('impF').click()">
        <span class="st-ico">ğŸ“¥</span>
        <div class="st-txt"><div class="st-m">Import Data</div><div class="st-s">Restore from backup</div></div>
        <span class="st-chv">â€º</span>
      </div>
      <input type="file" id="impF" accept=".json" style="display:none" onchange="importData(event)">
      <div class="st-row" onclick="confirmReset()">
        <span class="st-ico">ğŸ—‘ï¸</span>
        <div class="st-txt"><div class="st-m" style="color:var(--red)">Reset All Data</div><div class="st-s">Delete everything</div></div>
        <span class="st-chv">â€º</span>
      </div>
    </div>
  </section>
</main>

<button class="fab" onclick="openAddExp()">+</button>

<nav class="b-nav">
  <button class="n-item act" data-n="activity" onclick="switchNav('activity')"><span class="n-ico">ğŸ“‹</span>Activity</button>
  <button class="n-item" data-n="friends" onclick="switchNav('friends')"><span class="n-ico">ğŸ‘¥</span>Friends</button>
  <div class="n-item" style="pointer-events:none"></div>
  <button class="n-item" data-n="settle" onclick="switchNav('settle')"><span class="n-ico">âœ…</span>Settle</button>
  <button class="n-item" data-n="settings" onclick="switchNav('settings')"><span class="n-ico">âš™ï¸</span>More</button>
</nav>

<!-- Add Expense Modal -->
<div class="mo" id="expMo">
  <div class="ms">
    <div class="m-handle"></div>
    <div class="m-head">
      <span class="m-title">Add expense</span>
      <button class="m-close" onclick="closeMo('expMo')">âœ•</button>
    </div>
    <div class="m-body">
      <div class="fg"><label class="fl">Description</label><input type="text" class="fi" id="eDesc" placeholder="What was this for?"></div>
      <div class="fr">
        <div class="fg"><label class="fl">Amount</label><div class="amt-w"><span class="cpx" id="mCur">â‚¹</span><input type="number" class="fi" id="eAmt" placeholder="0.00" step="0.01" min="0" inputmode="decimal"></div></div>
        <div class="fg"><label class="fl">Paid by</label><select class="fi" id="ePaid"></select></div>
      </div>
      <div class="fg"><label class="fl">Category</label>
        <select class="fi" id="eCat">
          <option value="ğŸ• Food">ğŸ• Food & Drink</option>
          <option value="ğŸ  Rent">ğŸ  Rent / Housing</option>
          <option value="ğŸš• Transport">ğŸš• Transport</option>
          <option value="ğŸ›’ Groceries">ğŸ›’ Groceries</option>
          <option value="ğŸ¬ Entertainment">ğŸ¬ Entertainment</option>
          <option value="âš¡ Utilities">âš¡ Utilities</option>
          <option value="ğŸ¥ Medical">ğŸ¥ Medical</option>
          <option value="ğŸ“¦ Other">ğŸ“¦ Other</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Split equally among</label><div class="cg" id="eSplit"></div></div>
      <button class="btn btn-p" onclick="saveExp()" style="margin-top:8px">Add expense</button>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="mo" id="detMo">
  <div class="ms">
    <div class="m-handle"></div>
    <div class="m-head">
      <span class="m-title">Expense details</span>
      <button class="m-close" onclick="closeMo('detMo')">âœ•</button>
    </div>
    <div class="m-body" id="detBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK='spliteasy_data';
const COLS=['#1B998B','#3B82F6','#F59E0B','#EC4899','#8B5CF6','#EF4444','#14B8A6','#F97316','#6366F1','#10B981'];
const CM={'ğŸ•':'c-food','ğŸ ':'c-rent','ğŸš•':'c-trans','ğŸ›’':'c-groc','ğŸ¬':'c-ent','âš¡':'c-util','ğŸ¥':'c-med','ğŸ“¦':'c-oth'};

let S=ld(), cFilt='all';

function df(){return{members:[],expenses:[],currency:'â‚¹',simplify:true}}
function ld(){try{const s=JSON.parse(localStorage.getItem(SK));return s&&s.members?s:df()}catch{return df()}}
function sv(){localStorage.setItem(SK,JSON.stringify(S))}
function cl(n){return COLS[S.members.indexOf(n)%COLS.length]}
function ini(n){const p=n.trim().split(/\s+/);return(p.length>1?p[0][0]+p[1][0]:n.substring(0,2)).toUpperCase()}
function avH(n,c){return '<div class="av '+(c||'')+'" style="background:'+cl(n)+'">'+ini(n)+'</div>'}
function ci(c){return c?c.split(' ')[0]:'ğŸ“¦'}
function cc(c){return CM[ci(c)]||'c-oth'}
function fm(n){return S.currency+Math.abs(n).toFixed(2)}
function fs(n){return S.currency+Math.abs(n).toFixed(0)}
function rd(iso){
  const d=new Date(iso),now=new Date(),diff=Math.floor((now-d)/864e5);
  if(diff===0)return'Today';if(diff===1)return'Yesterday';
  if(diff<7)return d.toLocaleDateString('en-IN',{weekday:'short'});
  return d.toLocaleDateString('en-IN',{day:'numeric',month:'short'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Navigation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchNav(tab){
  document.querySelectorAll('.n-item[data-n]').forEach(n=>n.classList.toggle('act',n.dataset.n===tab));
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('act'));
  const sec=document.getElementById('s-'+tab);
  if(sec) sec.classList.add('act');
  document.getElementById('bHero').style.display=(tab==='activity')?'':'none';
  if(tab==='friends') renderFriends();
  if(tab==='settle') renderSettle();
  if(tab==='activity') renderAct();
  if(tab==='settings') renderMem();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Balance Hero
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHero(){
  const bal=calcBal();
  let owed=0,owe=0;
  S.members.forEach(m=>{const b=bal[m]||0;if(b>0.01)owed+=b;if(b<-0.01)owe+=Math.abs(b)});
  const total=S.expenses.reduce((s,e)=>s+e.amount,0);
  document.getElementById('bCards').innerHTML=
    '<div class="b-card"><div class="b-card-l">Total Spent</div><div class="b-card-v">'+fs(total)+'</div></div>'+
    '<div class="b-card"><div class="b-card-l">You\'re owed</div><div class="b-card-v pos">'+fs(owed)+'</div></div>'+
    '<div class="b-card"><div class="b-card-l">You owe</div><div class="b-card-v neg">'+fs(owe)+'</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Activity Feed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cycleFilter(){
  const f=['all',...S.members];
  const i=(f.indexOf(cFilt)+1)%f.length;
  cFilt=f[i];
  document.getElementById('filterBtn').textContent=cFilt==='all'?'All':cFilt;
  renderAct();
}

function renderAct(){
  renderHero();
  const el=document.getElementById('actList');
  let list=[...S.expenses];
  if(cFilt!=='all') list=list.filter(e=>e.paidBy===cFilt||e.splitAmong.includes(cFilt));
  if(!list.length){
    el.innerHTML='<div class="empty"><div class="empty-i">ğŸ’¸</div><div class="empty-t">No expenses yet</div><div class="empty-d">Tap the orange + button to add your first shared expense</div></div>';
    return;
  }
  el.innerHTML=list.slice().reverse().map(function(e){
    return '<div class="a-item" onclick="showDet('+e.id+')">'+
      '<div class="a-ico '+cc(e.category)+'">'+ci(e.category)+'</div>'+
      '<div class="a-body"><div class="a-desc">'+e.desc+'</div><div class="a-meta">'+e.paidBy+' paid Â· '+rd(e.date)+'</div></div>'+
      '<div class="a-right"><div class="a-amt paid">'+fm(e.amount)+'</div><div class="a-sub">'+e.splitAmong.length+' people</div></div></div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Expense Detail
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDet(id){
  const e=S.expenses.find(x=>x.id===id);
  if(!e)return;
  const share=e.amount/e.splitAmong.length;
  const ds=new Date(e.date).toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  let h='<div style="text-align:center;padding:8px 0 20px">'+
    '<div class="a-ico '+cc(e.category)+'" style="width:56px;height:56px;font-size:1.6rem;margin:0 auto 12px;border-radius:16px">'+ci(e.category)+'</div>'+
    '<div style="font-weight:800;font-size:1.5rem">'+fm(e.amount)+'</div>'+
    '<div style="font-size:1rem;font-weight:600;margin-top:4px">'+e.desc+'</div>'+
    '<div style="font-size:0.8rem;color:var(--text-2);margin-top:4px">'+ds+'</div></div>';

  h+='<div style="background:var(--bg);border-radius:var(--r-sm);padding:14px 16px;margin-bottom:16px">'+
    '<div style="font-size:0.75rem;font-weight:600;color:var(--text-2);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px">Paid by</div>'+
    '<div style="display:flex;align-items:center;gap:10px">'+avH(e.paidBy,'av-s')+
    '<span style="font-weight:600">'+e.paidBy+'</span>'+
    '<span style="margin-left:auto;font-weight:700;color:var(--teal)">'+fm(e.amount)+'</span></div></div>';

  h+='<div style="background:var(--bg);border-radius:var(--r-sm);padding:14px 16px;margin-bottom:20px">'+
    '<div style="font-size:0.75rem;font-weight:600;color:var(--text-2);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:10px">Split between ('+fm(share)+' each)</div>';
  e.splitAmong.forEach(function(m){
    const isPayer=m===e.paidBy;
    const amtColor=isPayer?'var(--teal)':'var(--red)';
    const amtText=isPayer?'+'+fm(e.amount-share):'-'+fm(share);
    h+='<div style="display:flex;align-items:center;gap:10px;padding:6px 0">'+avH(m,'av-s')+
      '<span style="font-weight:500">'+m+'</span>'+
      '<span style="margin-left:auto;font-weight:600;color:'+amtColor+'">'+amtText+'</span></div>';
  });
  h+='</div><button class="btn btn-d" onclick="delExp('+e.id+');closeMo(\'detMo\')">Delete expense</button>';

  document.getElementById('detBody').innerHTML=h;
  openMo('detMo');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Friends / Balances
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFriends(){
  const el=document.getElementById('fList');
  if(!S.members.length){
    el.innerHTML='<div class="empty"><div class="empty-i">ğŸ‘¥</div><div class="empty-t">No friends yet</div><div class="empty-d">Go to More tab to add friends</div></div>';
    return;
  }
  const bal=calcBal();
  el.innerHTML=S.members.map(function(m){
    const b=bal[m]||0;
    const cls=b>0.01?'am-pos':b<-0.01?'am-neg':'am-z';
    const label=b>0.01?'gets back':b<-0.01?'owes':'settled up';
    return '<div class="p-item">'+avH(m)+
      '<div class="p-info"><div class="p-name">'+m+'</div><div class="p-det">'+label+'</div></div>'+
      '<span class="p-amt '+cls+'">'+(Math.abs(b)<0.01?'â€”':fm(b))+'</span></div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Balances & Settlements
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcBal(){
  const bal={};
  S.members.forEach(function(m){bal[m]=0});
  S.expenses.forEach(function(e){
    const share=e.amount/e.splitAmong.length;
    bal[e.paidBy]=(bal[e.paidBy]||0)+e.amount;
    e.splitAmong.forEach(function(m){bal[m]=(bal[m]||0)-share});
  });
  return bal;
}

function toggleSimplify(){
  S.simplify=!S.simplify;sv();
  document.getElementById('simpTg').classList.toggle('on',S.simplify);
  renderSettle();
}

function calcSettle(){
  const bal=calcBal(),txns=[];
  if(S.simplify){
    const dbt=[],crd=[];
    S.members.forEach(function(m){const b=bal[m]||0;if(b<-0.01)dbt.push({n:m,a:-b});else if(b>0.01)crd.push({n:m,a:b})});
    dbt.sort(function(a,b){return b.a-a.a});crd.sort(function(a,b){return b.a-a.a});
    let i=0,j=0;
    while(i<dbt.length&&j<crd.length){
      const p=Math.min(dbt[i].a,crd[j].a);
      if(p>0.01)txns.push({from:dbt[i].n,to:crd[j].n,amount:p});
      dbt[i].a-=p;crd[j].a-=p;
      if(dbt[i].a<0.01)i++;if(crd[j].a<0.01)j++;
    }
  }else{
    S.expenses.forEach(function(e){
      const share=e.amount/e.splitAmong.length;
      e.splitAmong.forEach(function(m){if(m!==e.paidBy)txns.push({from:m,to:e.paidBy,amount:share})});
    });
  }
  return txns;
}

function renderSettle(){
  document.getElementById('simpTg').classList.toggle('on',S.simplify);
  const el=document.getElementById('setList');
  const txns=calcSettle();
  if(!txns.length){
    el.innerHTML='<div class="card"><div class="empty"><div class="empty-i">ğŸ‰</div><div class="empty-t">All settled up!</div><div class="empty-d">No payments needed</div></div></div>';
    return;
  }
  el.innerHTML=txns.map(function(t){
    return '<div class="s-card"><div class="s-flow">'+
      avH(t.from,'av-s')+'<span style="font-weight:600;font-size:0.88rem">'+t.from+'</span>'+
      '<span class="s-arr">â†’</span>'+
      '<span style="font-weight:600;font-size:0.88rem">'+t.to+'</span>'+
      avH(t.to,'av-s')+'</div><div class="s-amt">'+fm(t.amount)+'</div></div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Members
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMember(){
  const inp=document.getElementById('newMem');
  const name=inp.value.trim();
  if(!name)return;
  if(S.members.find(function(m){return m.toLowerCase()===name.toLowerCase()}))return toast('Already exists');
  S.members.push(name);sv();inp.value='';renderMem();toast(name+' added');
}

function removeMember(name){
  if(S.expenses.some(function(e){return e.paidBy===name||e.splitAmong.includes(name)}))return toast('Remove their expenses first');
  S.members=S.members.filter(function(m){return m!==name});sv();renderMem();
}

function renderMem(){
  const el=document.getElementById('memList');
  if(!S.members.length){el.innerHTML='<span style="color:var(--text-3);font-size:0.85rem">No members yet</span>';return}
  el.innerHTML=S.members.map(function(m){
    return '<div class="mc">'+avH(m,'av-xxs')+'<span>'+m+'</span>'+
      '<button class="mc-x" onclick="event.stopPropagation();removeMember(\''+m.replace(/'/g,"\\'")+'\')">âœ•</button></div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Expense CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAddExp(){
  if(S.members.length<2)return toast('Add at least 2 friends first');
  openMo('expMo');
  document.getElementById('eDesc').value='';
  document.getElementById('eAmt').value='';
  document.getElementById('mCur').textContent=S.currency;
  document.getElementById('ePaid').innerHTML=S.members.map(function(m){return'<option value="'+m+'">'+m+'</option>'}).join('');
  document.getElementById('eSplit').innerHTML=S.members.map(function(m){
    return '<div class="chip sel" onclick="this.classList.toggle(\'sel\')" data-m="'+m+'">'+
      avH(m,'av-xxs')+'<span>'+m+'</span></div>';
  }).join('');
  setTimeout(function(){document.getElementById('eDesc').focus()},200);
}

function saveExp(){
  const desc=document.getElementById('eDesc').value.trim();
  const amount=parseFloat(document.getElementById('eAmt').value);
  const paidBy=document.getElementById('ePaid').value;
  const category=document.getElementById('eCat').value;
  const splitAmong=[];
  document.querySelectorAll('#eSplit .chip.sel').forEach(function(c){splitAmong.push(c.dataset.m)});

  if(!desc)return toast('Add a description');
  if(!amount||amount<=0)return toast('Enter a valid amount');
  if(splitAmong.length<1)return toast('Select at least 1 person');

  S.expenses.push({id:Date.now(),desc:desc,amount:amount,paidBy:paidBy,category:category,splitAmong:splitAmong,date:new Date().toISOString()});
  sv();closeMo('expMo');renderAct();toast('Expense added âœ“');
}

function delExp(id){
  S.expenses=S.expenses.filter(function(e){return e.id!==id});
  sv();renderAct();toast('Expense deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Modals
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMo(id){document.getElementById(id).classList.add('show');document.body.style.overflow='hidden'}
function closeMo(id){document.getElementById(id).classList.remove('show');document.body.style.overflow=''}
document.querySelectorAll('.mo').forEach(function(m){
  m.addEventListener('click',function(e){if(e.target===m)closeMo(m.id)});
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Search
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSearch(){
  const q=prompt('Search expenses:');
  if(!q)return;
  const res=S.expenses.filter(function(e){return e.desc.toLowerCase().includes(q.toLowerCase())||e.paidBy.toLowerCase().includes(q.toLowerCase())});
  if(!res.length)return toast('No results');
  toast('Found '+res.length+' expense(s)');
  switchNav('activity');
  setTimeout(function(){
    document.getElementById('actList').innerHTML=res.reverse().map(function(e){
      return '<div class="a-item" onclick="showDet('+e.id+')" style="background:var(--teal-50)">'+
        '<div class="a-ico '+cc(e.category)+'">'+ci(e.category)+'</div>'+
        '<div class="a-body"><div class="a-desc">'+e.desc+'</div><div class="a-meta">'+e.paidBy+' paid Â· '+rd(e.date)+'</div></div>'+
        '<div class="a-right"><div class="a-amt paid">'+fm(e.amount)+'</div><div class="a-sub">'+e.splitAmong.length+' people</div></div></div>';
    }).join('');
  },100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Settings
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCurrency(){
  const c=prompt('Enter currency symbol:',S.currency);
  if(c!==null&&c.trim()){S.currency=c.trim();sv();document.getElementById('curDisp').textContent=S.currency;renderAct();toast('Currency updated')}
}
function confirmReset(){
  if(confirm('Delete ALL expenses and members? This cannot be undone.')){S=df();sv();renderAll();toast('All data cleared')}
}
function exportData(){
  const b=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);
  a.download='spliteasy-'+new Date().toISOString().slice(0,10)+'.json';
  a.click();URL.revokeObjectURL(a.href);toast('Exported âœ“');
}
function importData(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=function(ev){
    try{const d=JSON.parse(ev.target.result);if(d.members&&d.expenses){S=d;sv();renderAll();toast('Imported âœ“')}else toast('Invalid file')}
    catch(err){toast('Error reading file')}
  };r.readAsText(f);e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Toast
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  clearTimeout(t._t);t._t=setTimeout(function(){t.classList.remove('show')},2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){renderHero();renderAct();renderMem();document.getElementById('curDisp').textContent=S.currency}
renderAll();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker' in navigator){
  window.addEventListener('load',function(){
    navigator.serviceWorker.register('sw.js').catch(function(){});
  });
}
let dPr;
window.addEventListener('beforeinstallprompt',function(e){
  e.preventDefault();dPr=e;
  if(document.getElementById('instBan'))return;
  const d=document.createElement('div');d.id='instBan';
  d.innerHTML='<div style="position:fixed;bottom:calc(76px + var(--sab) + 8px);left:16px;right:16px;z-index:55;background:var(--white);border-radius:var(--r);padding:16px;display:flex;align-items:center;gap:14px;box-shadow:var(--sh-lg);max-width:528px;margin:0 auto;animation:su .4s ease">'+
    '<span style="font-size:2rem">ğŸ“²</span>'+
    '<div style="flex:1"><div style="font-weight:700;font-size:0.9rem">Install SplitEasy</div><div style="font-size:0.75rem;color:var(--text-2);margin-top:2px">Add to home screen</div></div>'+
    '<button class="btn btn-p btn-sm" onclick="instPWA()">Install</button>'+
    '<button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-3);cursor:pointer;font-size:1rem;padding:4px;position:absolute;top:8px;right:8px">âœ•</button></div>';
  document.body.appendChild(d);
});
async function instPWA(){
  if(!dPr)return;dPr.prompt();
  const{outcome}=await dPr.userChoice;
  if(outcome==='accepted')toast('Installed! ğŸ‰');
  dPr=null;var b=document.getElementById('instBan');if(b)b.remove();
}
window.addEventListener('appinstalled',function(){var b=document.getElementById('instBan');if(b)b.remove()});
</script>
</body>
</html>
